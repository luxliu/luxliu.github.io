<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Lux&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="Action as a normal"/>
<meta name="keywords" content="Action as a normal"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://luxliu.github.io/favicon.ico">

<link rel="stylesheet" href="https://luxliu.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://luxliu.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://luxliu.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://luxliu.github.io/images/avatar.png" alt="Lux&#39;s Blog"
                 class="img-responsive">
        </figure>
        <a href="https://luxliu.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>Lux&#39;s Blog</h2>
        <p>Action as a normal</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://luxliu.github.io/tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
                    <li><a href="https://luxliu.github.io/tag/2vNKS4OOD/">JavaScript</a></li>
                
                    <li><a href="https://luxliu.github.io/tag/I2nhd0xXh/">Basic</a></li>
                
                    <li><a href="https://luxliu.github.io/tag/5R0JrNhKn/">Webpack</a></li>
                
                    <li><a href="https://luxliu.github.io/tag/_rN6fbSe1/">CI/CD</a></li>
                
                    <li><a href="https://luxliu.github.io/tag/_C5EmWh7M/">Career</a></li>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            Home
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            Archives
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            Tags
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            About
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://luxliu.github.io">Lux&#39;s Blog </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://luxliu.github.io/post-images/webpack-performance.png" alt="How to improve performance in webpack" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
                    <div class="tag-container">
                        
                            <a href="https://luxliu.github.io/tag/5R0JrNhKn/" class="tag">Webpack, </a>
                        
                    </div>
                
            </span>
            <h2 class="fh5co-article-title animate-box">How to improve performance in webpack</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2020-05-27</li>
                <li>1593字</li>
                <li>10 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <p>As the front-end side is becoming bigger and more complex, sometimes we have to face to the issue of performance. Briefly, we hope the users will experience our web app as faster as possible. This is about to minimize the request files size and optimize the request order. Let's have a look at how could we do this in webpack.</p>
<h4 id="1-tree-shaking">1. Tree Shaking</h4>
<p>As the naming, tree shaking will shake the useless modules even it's claimed in some other files. This will decrease bundle size.</p>
<p>Let's say I have two functions in <code>math.js</code> file:</p>
<pre><code class="language-javascript">export const add = (a, b) =&gt; {
	console.log( a + b );
}

export const minus = (a, b) =&gt; {
	console.log( a - b );
}
</code></pre>
<p>And I only import the <code>add</code> function like this:</p>
<pre><code class="language-javascript">import { add } from './math.js';
add(1, 2);
</code></pre>
<blockquote>
<p>Note: webpack tree shaking only supports the es6 module <code>import</code>, but doesn't support commonJS <code>require</code>, as the es6 <code>import</code> underlying  implementation is static but <code>requires</code> is  dynamic.</p>
</blockquote>
<p>If I have no tree shaking feature here, the bundle will also include the <code>minus</code> function code, which is useless and raise the bundle size.</p>
<p>How do we config tree shaking in webpack?</p>
<h5 id="on-development-mode">On development mode:</h5>
<p>If you need to config for dev mode, make sure you add <code>usedExports</code> within <code>optimization</code> property in your <code>webpack.config.js</code> file like this:</p>
<pre><code class="language-js">optimization: {
    usedExports: true
}
</code></pre>
<p>And, in <code>package.json</code> you should add one line just for future convenience:</p>
<pre><code class="language-json">&quot;sideEffect&quot;: []
</code></pre>
<blockquote>
<p>With this <code>sideEffect</code>, you can add whatever you will let webpack ignores when tree shaking. E.g. you need to <code>import '@babel/polly-fill'</code> in your entry file to do polly-fill job. As you don't use anything of this polly-fill module here, webpack will shake the whole babel/polly-fill module which is not you expect. In this case, you can add this module into the <code>sideEffect</code> array: <code>&quot;sideEffect&quot;: [&quot;@babel/polly-fill&quot;]</code>. Another common example is for <code>import './style.css'</code> and <code>&quot;sideEffect&quot;: [&quot;*.css&quot;]</code>.</p>
</blockquote>
<p><strong>However</strong>, if you run webpack to bundle, you will find the output file still includes the useless <code>minus</code> function but one extra comment before it to tell you <strong>&quot;exports provided: add, minus&quot;</strong> and <strong>&quot;exports used: add&quot;</strong>. The reason is that webpack considers remove these tree shaking modules might cause error when you use source map. So <strong>in development mode</strong>, webpack won't really remove the tree shaking modules code.</p>
<h5 id="on-production-mode">On production mode:</h5>
<p>Nothing need you to do! Webpack will do it for you by default. Just don't forget to add <code>&quot;sideEffect&quot;: []</code> in your <code>package.json</code> file and add something you prevent from tree shaking.</p>
<h4 id="2-code-splitting-and-lazy-loading">2. Code splitting and lazy loading</h4>
<p>I think almost most front-end developers used some utility library like <code>lodash</code>, <code>jquery</code> or <code>ramda</code>. The thing is when a file imports these libraries and use webpack to do the bundling job, the whole bundle size would be pretty big as all these 3rd party libraries are also included in the bundle file. This is not we want!</p>
<p>Let's say you are using <code>lodash</code> in <code>index.js</code> , and you can create another file called <code>lodash.js</code> to do this:</p>
<pre><code class="language-js">import _ from 'lodash';
window._ = _;
</code></pre>
<p>And add it as an extra entry file like this:</p>
<pre><code class="language-js">entry: {
    lodash: './src/lodash.js',
    main: './src/index.js'
}
</code></pre>
<p>With this solution, the bundled <code>index.html</code> will import <code>lodash.js</code> as another <code>&lt;script&gt;</code> file. The benefit is that we split business logic code and vendor code in two different files. When the user reload new code, the <code>lodash.js</code> already cached in browser, and this will speed up user experience.</p>
<blockquote>
<p>Don't forget to use <strong>[contentHash]</strong> as part of your output files naming, especially in production environment, to prevent caching of browser when code content already changed.</p>
</blockquote>
<blockquote>
<p>This concept is code splitting and doesn't matter with webpack. With webpack we can do it easily and simply.</p>
</blockquote>
<p>Just do this in webpack.config.js` file:</p>
<pre><code class="language-js">optimization: {
    splitChunks: {
        chunks: 'all'
    }
}
</code></pre>
<p>Then you will find webpack does the code splitting for you: you will get one extra bundle file: <code>vendors~main.js</code> which includes the imported libraries.</p>
<blockquote>
<p>For more configurations of splitChunks plugin of webpack, you can read its <a href="https://webpack.js.org/plugins/split-chunks-plugin/#root">official documents</a></p>
</blockquote>
<p>Actually, lazy loading can't leave code splitting. Image following code:</p>
<pre><code class="language-js">const getComponent = () =&gt; {
  return import('lodash').then(({ default: _ }) =&gt; {
    const element = document.createElement('div');
    element.innerHTML = _.join(['Lux', 'Liu'], '-');
    return element;
  });
};

document.addEventListener('click', () =&gt; {
  getComponent().then((element) =&gt; {
    document.body.appendChild(element);
  });
});
</code></pre>
<p>And use webpack to bundle project, you should find <code>lodash</code> is bundled in <code>vendors~*.js</code> and the top code is bundled in <code>main.js</code>. Inspect bundled landing page <code>index.html</code> in your browser and open network, you will find only <code>index.html</code> and <code>main.js</code> are requested when you load <code>index.html</code>. Once you click the page, you will see &quot;Lux-Liu&quot; on your page and the <code>vendors~*.js</code> is just requested after you click the page. This is lazy loading and obviously, it will speed up the UX.</p>
<blockquote>
<p>Don't forget to use polly-fill or <a href="https://babeljs.io/docs/en/babel-plugin-syntax-dynamic-import">@babel/plug-syntax-dynamic-import</a> plugin for this experimental syntax.</p>
</blockquote>
<p>Do you remember we have a configuration for code splitting?</p>
<pre><code class="language-js">optimization: {
    splitChunks: {
        chunks: 'all'
    }
}
</code></pre>
<p>If you have no this configuration, webpack will still do code splitting for you, <strong>but only the dynamic import</strong>.</p>
<p>Have a look at the <a href="https://babeljs.io/docs/en/babel-plugin-syntax-dynamic-import">default config</a> of splitChunk plugin:</p>
<pre><code class="language-js">module.exports = {
  //...
  optimization: {
    splitChunks: {
      chunks: 'async',
      minSize: 30000,
      minRemainingSize: 0,
      maxSize: 0,
      minChunks: 1,
      maxAsyncRequests: 6,
      maxInitialRequests: 4,
      automaticNameDelimiter: '~',
      cacheGroups: {
        defaultVendors: {
          test: /[\\/]node_modules[\\/]/,
          priority: -10
        },
        default: {
          minChunks: 2,
          priority: -20,
          reuseExistingChunk: true
        }
      }
    }
  }
};
</code></pre>
<p>By default, the <code>chunks</code> has a <code>async</code> value, which indicates <strong>webpack encourage us to use this lazy loading/dynamic import</strong>.</p>
<h4 id="3-bundle-analyse-preloading-and-prefetching">3. Bundle analyse, preloading and prefetching</h4>
<p>In the real practice, we usually use <a href="https://github.com/webpack/analyse">webpack analyse</a> to do the bundle analysis job.</p>
<p>The process is pretty straight forward and simple:</p>
<ul>
<li>Run <code>webpack --profile --json &gt; stats.json</code> , which also can be combined in your build script, like <code>&quot;dev-build&quot;: &quot;webpack --profile --json &gt; stats.json --config &lt;your_conf_file_path&gt;&quot;</code>;</li>
<li>Then you will get one <code>stats.json</code> file in the root directory;</li>
<li>Use it on http://webpack.github.io/analyse/. Webpack will tell you everything about this bundling, especially the chunks and modules dependency relationships;</li>
</ul>
<p>This is the official analyse tool, you also have some <a href="http://webpack.github.io/analyse/">other options</a>. Personally, I prefer <a href="https://github.com/webpack-contrib/webpack-bundle-analyzer">webpack bundle analyzer</a>, which will give a clear and intuitional map like this:</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/luxliu/Picbed_picGo/master/webpack/webpack-bundle-analyzer.png" alt="" loading="lazy"></figure>
<p>Now, let's back to the previous example:</p>
<pre><code class="language-js">const getComponent = () =&gt; {
  return import('lodash').then(({ default: _ }) =&gt; {
    const element = document.createElement('div');
    element.innerHTML = _.join(['Lux', 'Liu'], '-');
    return element;
  });
};

document.addEventListener('click', () =&gt; {
  getComponent().then((element) =&gt; {
    document.body.appendChild(element);
  });
});
</code></pre>
<p>Normally, when we define a click event we will write like this instead of the top one in the <code>index.js</code> file:</p>
<pre><code class="language-js">document.addEventListener('click', () =&gt; {
   const element = document.createElement('div');
   element.innerHTML = _.join(['Lux', 'Liu'], '-');
   document.body.appendChild(element);
});
</code></pre>
<p>It's pretty simple and good enough, right? Is there any place to optimize?</p>
<p>Bundle this app and inspect <code>index.html</code> in browser, for chrome, open the dev tool. Press <kbd>ctrl</kbd>+<kbd>shift</kbd>+<kbd>P</kbd>, and input <strong>coverage</strong> then choose <strong>show coverage</strong>, you should get a new dev window open similar with this:</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/luxliu/Picbed_PicGo/master/webpack/coverage.png" alt="" loading="lazy"></figure>
<p>This coverage window tells you how much the code is used on this page for all requested files right now. The red bar is unused part and blue bar is used part on this page. If we wanna improve performance, we should minimize the red part.</p>
<p>How to do this in our code?</p>
<p>The main idea is to use dynamic/async import to split unused logic:</p>
<ol>
<li>
<p>create a <code>click.js</code> file:</p>
<pre><code class="language-js">const handleClick = () =&gt; {
    const element = document.createElement('div');
    element.innerHTML = 'Lux Liu';
    document.body.appendChild(element);
}

export default handleClick;
</code></pre>
</li>
<li>
<p>Dynamically import and use it in <code>index.js</code> file:</p>
<pre><code class="language-js">document.addEventListener('click', () =&gt; {
   import('./click.js').then(({default: func})=&gt;{
       func();
   })
});
</code></pre>
</li>
</ol>
<p>Obviously, webpack will split the async import code in different file. This means we implement the lazy loading, and the coverage of <code>main.js</code> will increase as the logic code decreases. Finally, the performance will be improved. That's why I said webpack encourages developers to write more dynamic import code.</p>
<p>However, we still have a problem: let's say we use this approach to implement an app which has a sign in/sign up popup modal. With this approach, this modal module won't be requested on the landing page until the user clicks a button to tell modal to popup.</p>
<p>The question is: how would we handle the gap issue between click and modal module request finishes?</p>
<p>The ideal solution for this problem should be like this: when the landing page code files requests finish, and the network resource is released, could we let browser request the sign in/sign up modal code file quietly?</p>
<p><a href="https://webpack.js.org/guides/code-splitting/#prefetchingpreloading-modules">Prefetching/Preloading</a> can do this for us.</p>
<p>It's very straight forward: add a magic comment when you import the splitting module:</p>
<pre><code class="language-js">document.addEventListener('click', () =&gt; {
   import(/* webpackPrefetch: true */ './click.js').then(({default: func})=&gt;{
       func();
   })
});
</code></pre>
<blockquote>
<p>A preloaded chunk starts loading in parallel to the parent chunk. A prefetched chunk starts after the parent chunk finishes loading</p>
</blockquote>
<p>Personally I prefer prefetch than preload.</p>
<h4 id="4-code-coverage-caching">4. Code coverage &gt; caching</h4>
<p>Usually when we talk about the performance of a web app, we are not talking the caching but the first UX performance, which means we are talking the bundle size and files request order.</p>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                            <div class="next-post">
                                <div class="next">下一篇</div>
                                <a href="https://luxliu.github.io/post/use-circleci-to-implement-cicd-of-front-end-code-and-deploy-to-aws-s3/">
                                    <h3 class="post-title">
                                        Use CircleCI to implement CI/CD and deploy to AWS S3
                                    </h3>
                                </a>
                            </div>
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#1-tree-shaking">1. Tree Shaking</a>
<ul>
<li><a href="#on-development-mode">On development mode:</a></li>
<li><a href="#on-production-mode">On production mode:</a></li>
</ul>
</li>
<li><a href="#2-code-splitting-and-lazy-loading">2. Code splitting and lazy loading</a></li>
<li><a href="#3-bundle-analyse-preloading-and-prefetching">3. Bundle analyse, preloading and prefetching</a></li>
<li><a href="#4-code-coverage-caching">4. Code coverage &gt; caching</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p></p>
</footer>


    <!-- jQuery -->
<script src="https://luxliu.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://luxliu.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://luxliu.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://luxliu.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://luxliu.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://luxliu.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://luxliu.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

    // img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
        var allImg = $("img");
        allImg.on("contextmenu", function () {
            return false;
        });
        allImg.on("dragstart", function () {
            return false;
        });
    
</script>




</body>
</html>
